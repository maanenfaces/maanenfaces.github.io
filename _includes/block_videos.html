<div id="videos" class="container scroll-margin pb-3">
    <div class="row">
        <div class="col text-center pb-4">
            <h2 class="visually-hidden">{% t h2_sections.videos %}</h2>
            <img class="mf-section-title-img"
                 src="/assets/img/section-title-videos-{{ site.lang }}.png" width="200" />
        </div>
    </div>
    <div class="row justify-content-center">

        {% for item in site.data.videos %}
        <div class="{{ item.css_class | default: 'col-lg-5' }}">
            <div class="border border-custom mb-4">
                <div class="auto-resize-yt-iframe">
                    <div class="youtube-lite"
                         {% if item.release_date_preview_img_url %}
                         data-preview-img-url="{{ item.release_date_preview_img_url }}"
                         {% elsif item.preview_img_url %}
                         data-preview-img-url="{{ item.preview_img_url }}"
                         {% else %}
                         data-preview-img-url="https://img.youtube.com/vi/{{ item.yt_video_id }}/maxresdefault.jpg"
                         {% endif %}
                         data-yt-video-id="{{ item.yt_video_id }}"
                         data-start-at-in-seconds="{{ item.start_at_in_seconds | default: 0 }}"
                         data-title="{{ item.title | default: '' }}"
                         data-release-date="{{ item.release_date }}"> </div>
                </div>
            </div>
        </div>
        {% endfor %}

    </div>
    <div class="row">
        <div class="col text-center">
            <a class="btn btn-outline-light" href="https://www.youtube.com/@MaanenFaces" target="_blank" rel="noopener">
                {% t _.all_videos_on_youtube %}
            </a>
        </div>
    </div>
</div>

<link rel="stylesheet" href="/assets/css/youtube-lite.css">

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const ytLite = document.querySelectorAll(".youtube-lite");
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        // Fonction pour parser YYYY-MM-DD-HH-MM en objet Date UTC
        function parseReleaseDateUTC(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('-');
            if (parts.length < 5) return null;
            // Date.UTC(year, monthIndex, day, hour, minute)
            // Attention: le mois en JS commence Ã  0 (janvier = 0)
            return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], parts[3], parts[4]));
        }

        ytLite.forEach(el => {
            const previewImgUrl = el.dataset.previewImgUrl;
            const startAt = el.dataset.startAtInSeconds;
            const title = el.dataset.title;
            const videoId = el.dataset.ytVideoId;
            const releaseDateStr = el.dataset.releaseDate;

            const releaseDate = parseReleaseDateUTC(releaseDateStr);
            let isLocked = false;

            // CrÃ©ation de l'image de preview
            const video_img = document.createElement("img");
            video_img.className = "img-fluid object-fit-fill";
            video_img.src = previewImgUrl;
            video_img.alt = "YouTube preview image";
            video_img.loading = "lazy";

            // Titre de la vidÃ©o
            const video_title = document.createElement("div");
            video_title.className = "youtube-lite-title";
            video_title.textContent = title;

            el.replaceChildren(video_img, video_title);

            // Gestion du Countdown
            if (releaseDate && releaseDate > new Date()) {
                isLocked = true;
                el.classList.add("video-locked");

                const countdownOverlay = document.createElement("div");
                countdownOverlay.className = "youtube-lite-countdown";
                el.appendChild(countdownOverlay);

                const updateTimer = () => {
                    const now = new Date();
                    const diff = releaseDate - now;

                    if (diff <= 0) {
                        isLocked = false;
                        el.classList.remove("video-locked");
                        countdownOverlay.remove();
                        clearInterval(timerInterval);
                        return;
                    }

                    // Calculs de base
                    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);

                    // Formatage avec padStart pour garantir 2 chiffres (sauf pour les jours)
                    const days = d.toString().padStart(2, '0');
                    const hours = h.toString().padStart(2, '0');
                    const minutes = m.toString().padStart(2, '0');
                    const seconds = s.toString().padStart(2, '0');

                    // RÃ©sultat : DD - HH:MM:SS
                    if (d > 0) {
                        countdownOverlay.textContent = `${days}D - ${hours}:${minutes}:${seconds}`;
                    } else {
                        countdownOverlay.textContent = `${hours}:${minutes}:${seconds}`;
                    }
                };

                const timerInterval = setInterval(updateTimer, 1000);
                updateTimer();
            }

            el.addEventListener("click", function() {
                if (isLocked) return; // EmpÃªche le clic si pas encore sorti

                const video_loadtext = document.createElement("div");
                video_loadtext.className = "youtube-lite-loadtext";
                video_loadtext.textContent = "Loading video...";

                el.innerHTML = "";
                el.appendChild(video_loadtext);

                const isMute = isMobile ? 1 : 0;

                const iframe = document.createElement("iframe");
                iframe.setAttribute("src", `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=${isMute}&playsinline=1&start=${startAt}&enablejsapi=1`);
                iframe.setAttribute("frameborder", "0");
                iframe.setAttribute("allowfullscreen", "1");
                iframe.setAttribute("allow", "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture");
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.onload = () => {
                    video_loadtext.remove();
                    if (isMute === 1) {
                        const unmute_btn = document.createElement("button");
                        unmute_btn.className = "btn btn-light youtube-lite-unmute-btn";
                        unmute_btn.textContent = "ðŸ”Š Unmute";
                        unmute_btn.onclick = (e) => {
                            e.stopPropagation();
                            iframe.contentWindow.postMessage('{"event":"command","func":"unMute","args":""}', '*');
                            unmute_btn.remove();
                        };
                        el.appendChild(unmute_btn);
                    }
                };

                el.appendChild(iframe);
                el.classList.add("loaded");
            });
        });
    });
</script>
